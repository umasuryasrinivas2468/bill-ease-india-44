# Developer Quick Reference - Import Feature\n\n## File Map\n\n### Core Components\n```typescript\n// Main import dialog component\nimport ImportDialog from '@/components/ImportDialog';\n// Props: open, onOpenChange, moduleKey, onConfirmImport\n\n// Validation results display\nimport ImportPreview from '@/components/ImportPreview';\n// Props: validCount, invalidCount, validRows, invalidRows\n```\n\n### Utilities\n```typescript\n// CSV template definitions\nimport {\n  getTemplateHeaders,\n  getAllTemplateHeaders,\n  downloadTemplateCSV,\n  TEMPLATE_DEFINITIONS\n} from '@/utils/csvTemplates';\n\n// Validation engine\nimport { validateRows } from '@/utils/importValidator';\n// Returns: { valid: any[], invalid: Array<{ row, data, errors }> }\n```\n\n---\n\n## Integration Pattern\n\n### 1. Add Imports to Module Page\n```typescript\nimport ImportDialog from '@/components/ImportDialog';\nimport { supabase } from '@/lib/supabase';\n// Optional: import { useUser } from '@clerk/clerk-react';\n// Optional: Add Upload icon to existing imports\n```\n\n### 2. Add State\n```typescript\nconst [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n```\n\n### 3. Create Callback Function\n```typescript\nconst handleImportModule = async (validRows: any[]) => {\n  try {\n    const recordsToInsert = validRows.map((row) => ({\n      // Map CSV fields to database schema\n      field1: row.csv_field_1,\n      field2: row.csv_field_2,\n      // ...\n    }));\n\n    const { error } = await supabase\n      .from('table_name')\n      .insert(recordsToInsert);\n    \n    if (error) throw error;\n\n    setIsImportDialogOpen(false);\n    toast({\n      title: 'Import Successful',\n      description: `${validRows.length} records imported successfully.`,\n    });\n  } catch (err) {\n    console.error('Import error:', err);\n    toast({\n      title: 'Import Failed',\n      description: 'Failed to import records. Please try again.',\n      variant: 'destructive',\n    });\n  }\n};\n```\n\n### 4. Add Import Button in UI\n```tsx\n<Button \n  variant=\"outline\" \n  onClick={() => setIsImportDialogOpen(true)}\n>\n  <Upload className=\"h-4 w-4 mr-2\" />\n  Import\n</Button>\n```\n\n### 5. Add Dialog Component\n```tsx\n<ImportDialog\n  open={isImportDialogOpen}\n  onOpenChange={setIsImportDialogOpen}\n  moduleKey=\"module_name\"  // e.g., \"clients\", \"vendors\", etc.\n  onConfirmImport={handleImportModule}\n/>\n```\n\n---\n\n## Module Keys\n\n| Module | Key | CSV Fields | Required Fields |\n|--------|-----|-----------|------------------|\n| Clients | `\"clients\"` | client_name, email, phone, gst_number, billing_address, shipping_address, contact_person | client_name, email |\n| Vendors | `\"vendors\"` | vendor_name, email, phone, gst_number, billing_address, contact_person | vendor_name, email |\n| Invoices | `\"invoices\"` | invoice_number, invoice_date, due_date, client_name, item_description, quantity, rate, gst_rate, hsn_sac, notes, client_gst_number | invoice_number, invoice_date, client_name, item_description, quantity, rate |\n| Quotations | `\"quotations\"` | quotation_number, quotation_date, client_name, client_email, client_phone, client_address, item_description, quantity, rate, gst_rate, notes, hsn_sac | quotation_number, quotation_date, client_name, item_description, quantity, rate |\n\n---\n\n## Validation Rules\n\n### Built-in Validators\n```typescript\n// Email validation\n/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n\n// GST validation (15 alphanumeric)\n/^[0-9A-Z]{15}$/\n\n// Phone validation (10 digits or E.164)\n/(^\\d{10}$|^\\+91[0-9]{10}$|^\\+[0-9]{10,15}$)/\n\n// Date validation (YYYY-MM-DD)\n/^\\d{4}-\\d{2}-\\d{2}$/\n```\n\n### Custom Validation\nTo add custom validation for a field:\n\n1. Edit `src/utils/importValidator.ts`\n2. Add rule in `VALIDATION_RULES` object\n3. Follow existing pattern:\n```typescript\ncustom_field: {\n  validate: (value) => {\n    // Your validation logic\n    return isValid;\n  },\n  errorMessage: 'Custom error message'\n}\n```\n\n---\n\n## CSV Template Structure\n\n### Add New Template\nEdit `src/utils/csvTemplates.ts`:\n\n```typescript\nexport const TEMPLATE_DEFINITIONS: Record<string, TemplateDefinition> = {\n  // ...\n  new_module: {\n    requiredFields: ['field1', 'field2'],\n    optionalFields: ['field3', 'field4'],\n    headers: ['field1', 'field2', 'field3', 'field4']\n  }\n};\n```\n\n---\n\n## CSV Field Mapping\n\n### Example: Mapping CSV to Database Schema\n\n**CSV Columns**: `client_name`, `email`, `phone`  \n**Database Schema**: `name`, `email_address`, `phone_number`\n\n```typescript\nconst mapped = validRows.map((row) => ({\n  name: row.client_name,           // CSV â†’ DB mapping\n  email_address: row.email,\n  phone_number: row.phone,\n}));\n```\n\n---\n\n## Error Handling\n\n### Validation Errors\nAutomatically handled by `importValidator.ts`\n\n### Database Errors\n```typescript\nconst { error } = await supabase.from('table').insert(records);\nif (error) {\n  console.error('DB Error:', error);\n  // Show user-friendly error\n  throw new Error('Failed to import records');\n}\n```\n\n### User Feedback\n```typescript\ntoast({\n  title: 'Import Successful',\n  description: `${count} records imported.`,\n});\n\ntoast({\n  title: 'Import Failed',\n  description: 'Please check the errors and try again.',\n  variant: 'destructive',\n});\n```\n\n---\n\n## Adding New Features\n\n### Feature: Custom Field Validation\n1. Edit `src/utils/importValidator.ts`\n2. Add validation rule\n3. Test with invalid data\n4. Update documentation\n\n### Feature: Import History\n1. Create migration for `import_history` table\n2. Add insert logic after successful import\n3. Create component to display history\n4. Add to settings page\n\n### Feature: Batch Progress\n1. Modify ImportDialog to show progress\n2. Split import into batches\n3. Update progress bar per batch\n4. Show time estimate\n\n---\n\n## Testing Checklist\n\n### Unit Tests\n```typescript\n// Test validation rules\ntest('validates email format', () => {\n  const result = validateRows('clients', [\n    { client_name: 'Test', email: 'invalid' }\n  ]);\n  expect(result.invalid.length).toBe(1);\n});\n```\n\n### Integration Tests\n```typescript\n// Test complete import flow\ntest('imports valid records to database', async () => {\n  // Upload file\n  // Validate\n  // Import\n  // Verify database\n});\n```\n\n### Manual Tests\n- [ ] Download template from each module\n- [ ] Fill with valid data\n- [ ] Import and verify database\n- [ ] Fill with invalid data\n- [ ] Verify validation errors\n- [ ] Download error CSV\n- [ ] Test with 100+ rows\n- [ ] Test with different browsers\n\n---\n\n## Common Issues & Solutions\n\n### Issue: \"user_id is required\"\n**Solution**: Ensure `useUser()` hook is available and pass user.id\n```typescript\nconst { user } = useUser();\nconst records = validRows.map(row => ({\n  ...row,\n  user_id: user?.id\n}));\n```\n\n### Issue: \"Column not found\"\n**Solution**: Check CSV field names match template definition\n```typescript\n// CSV must have exact column names\nrequiredFields: ['client_name', 'email']\n// CSV: client_name,email,... (exact match)\n```\n\n### Issue: \"Duplicate records fail silently\"\n**Solution**: Add error handling for duplicate key constraint\n```typescript\nconst { error } = await supabase.from('table').insert(records);\nif (error?.code === '23505') { // Unique constraint violation\n  // Handle duplicate\n}\n```\n\n---\n\n## API Reference\n\n### ImportDialog Component\n```typescript\ninterface ImportDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  moduleKey: 'clients' | 'vendors' | 'invoices' | 'quotations';\n  onConfirmImport: (validRows: any[]) => void | Promise<void>;\n}\n```\n\n### validateRows Function\n```typescript\nfunction validateRows(\n  moduleKey: string,\n  rows: any[]\n): {\n  valid: any[];\n  invalid: Array<{ row: number; data: any; errors: string[] }>;\n}\n```\n\n### csvTemplates Exports\n```typescript\ngetTemplateHeaders(moduleKey: string): { required: string[]; optional: string[] }\ngetAllTemplateHeaders(moduleKey: string): string[]\ndownloadTemplateCSV(moduleKey: string): void\n```\n\n---\n\n## Performance Tips\n\n1. **Large Files**: Chunk imports into batches of 500 rows\n2. **Validation**: Cache validation rules in module state\n3. **Database**: Use batch insert instead of individual inserts\n4. **UI**: Show progress bar for files > 100 rows\n5. **Memory**: Don't store entire file in state, process in chunks\n\n---\n\n## Dependencies\n\n```json\n{\n  \"xlsx\": \"^0.18.0\",  // File parsing\n  \"react\": \"^18.0\",   // UI framework  \n  \"@supabase/supabase-js\": \"^2.0\",  // Database\n  \"shadcn/ui\": \"latest\",  // UI components\n  \"lucide-react\": \"latest\"  // Icons\n}\n```\n\nNo new dependencies added! Uses existing stack.\n\n---\n\n## Troubleshooting\n\n### Dialog Won't Open\n- Check `isImportDialogOpen` state\n- Verify `setIsImportDialogOpen` is called\n- Check onClick handler on button\n\n### Validation Not Working\n- Check module key matches TEMPLATE_DEFINITIONS\n- Verify CSV column names are exact\n- Check validator is imported correctly\n\n### Import Not Saving\n- Check Supabase table name is correct\n- Verify user has write permissions\n- Check field mapping is correct\n- Look at browser console for errors\n\n### File Upload Not Working\n- Check XLSX library is installed\n- Verify file format is CSV or XLSX\n- Check file size < 10 MB\n- Try different browser\n\n---\n\n## Documentation Map\n\n| Document | Audience | Content |\n|----------|----------|----------|\n| IMPORT_FEATURE_QUICK_START.md | End Users | Step-by-step instructions |\n| IMPORT_FEATURE_VISUAL_GUIDE.md | Visual Learners | Mockups and examples |\n| IMPORT_FEATURE_INTEGRATION.md | Developers | Technical architecture |\n| IMPORT_FEATURE_SUMMARY.md | Managers | Feature overview |\n| DEPLOYMENT_GUIDE.md | DevOps/QA | Testing and deployment |\n| This File | Developers | Quick reference |\n\n---\n\n## Code Examples\n\n### Example 1: Simple Module Import\n```typescript\nconst handleImportClients = async (validRows: any[]) => {\n  const { error } = await supabase\n    .from('clients')\n    .insert(validRows.map(row => ({\n      name: row.client_name,\n      email: row.email,\n    })));\n  \n  if (error) throw error;\n  \n  toast({ title: 'Imported!' });\n};\n```\n\n### Example 2: Complex Module with User ID\n```typescript\nconst { user } = useUser();\n\nconst handleImportVendors = async (validRows: any[]) => {\n  const { error } = await supabase\n    .from('vendors')\n    .insert(validRows.map(row => ({\n      name: row.vendor_name,\n      email: row.email,\n      user_id: user?.id,  // Auto-add user\n    })));\n  \n  if (error) throw error;\n};\n```\n\n### Example 3: Module with Calculations\n```typescript\nconst handleImportInvoices = async (validRows: any[]) => {\n  const { error } = await supabase\n    .from('invoices')\n    .insert(validRows.map(row => {\n      const amount = parseFloat(row.quantity) * parseFloat(row.rate);\n      const gstRate = parseFloat(row.gst_rate || 18);\n      return {\n        invoice_number: row.invoice_number,\n        amount: amount,\n        gst_amount: amount * (gstRate / 100),\n        total: amount * (1 + gstRate / 100),\n      };\n    })));\n  \n  if (error) throw error;\n};\n```\n\n---\n\n**Last Updated**: 2024  \n**Version**: 1.0  \n**Status**: Complete\n